

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Hector">
  <meta name="keywords" content="">
  
    <meta name="description" content="从简单的应用及驱动入手，浅析DRM子系统">
<meta property="og:type" content="article">
<meta property="og:title" content="DRM应用及驱动浅析">
<meta property="og:url" content="http://example.com/2022/10/21/DRM%E7%BB%BC%E5%90%88/index.html">
<meta property="og:site_name" content="Hector&#39;s Blog Page">
<meta property="og:description" content="从简单的应用及驱动入手，浅析DRM子系统">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/fb-plane.png">
<meta property="og:image" content="http://example.com/images/drm%E9%A9%B1%E5%8A%A8%E6%A0%B8%E5%BF%83.jpg">
<meta property="og:image" content="http://example.com/images/objs%E5%85%B3%E7%B3%BB%E5%9B%BE.png">
<meta property="article:published_time" content="2022-10-21T11:50:23.000Z">
<meta property="article:modified_time" content="2022-11-22T15:42:38.687Z">
<meta property="article:author" content="Hector">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/images/fb-plane.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>DRM应用及驱动浅析 - Hector&#39;s Blog Page</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  


<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Hector</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">DRM应用及驱动浅析</span>
          
        </div>

      </br>
      </br>
        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-21 19:50" pubdate>
          2022年10月21日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          27k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          222 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div> 
</div>



</div>


  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">DRM应用及驱动浅析</h1>
            
            
              <div class="markdown-body">
                
                <div align="center">

<blockquote>
<p>drm相关函数原型：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42645653/article/details/115486627">https://blog.csdn.net/weixin_42645653/article/details/115486627</a></p>
<p>参考何小龙老师的博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/hexiaolong2009/article/details/83720940">https://blog.csdn.net/hexiaolong2009/article/details/83720940</a></p>
</blockquote>
<h3 id="1-DRM简介"><a href="#1-DRM简介" class="headerlink" title="1.DRM简介"></a>1.DRM简介</h3></div>

<blockquote>
<p>DRM 是linux图形显示子系统，主要分为三个部分：</p>
</blockquote>
<ol>
<li>libdrm：for userspace，提供各种API供用户空间使用，主要是对IOCTL函数的封装；</li>
<li>KMS：kernel mode setting，主要作用是设置参数和控制显示；</li>
<li>GEM：graphic execution manager，主要做内存管理</li>
</ol>
<p>在驱动侧主要工作在和KMS和GEM上，这两个模块又包含以下元素：</p>
<ul>
<li>KMS：<ul>
<li>crtc：对显示buffer进行扫描，并产生时序信号的硬件模块，通常指Display Controller； </li>
<li>encoder：负责将CRTC输出的timing时序转换成外部设备所需要的信号的模块，如HDMI转换器或DSI Controller；</li>
<li>connector：连接物理显示设备的连接器，如HDMI、DisplayPort、DSI总线，通常和Encoder驱动绑定在一起；</li>
<li>plane：硬件图层，有的Display硬件支持多层合成显示，但所有的Display Controller至少要有1个plane；</li>
<li>framebuffer：Framebuffer，单个图层的显示内容，唯一一个和硬件无关的基本元素；</li>
<li>vblank：软件和硬件的同步机制，RGB时序中的垂直消影区，软件通常使用硬件VSYNC来实现；</li>
<li>property：任何你想设置的参数，都可以做成property，是DRM驱动中最灵活、最方便的Mode setting机制；</li>
</ul>
</li>
<li>GEM：<ul>
<li>dumb：只支持连续物理内存，基于kernel中通用CMA API实现，多用于小分辨率简单场景；</li>
<li>prime：连续、非连续物理内存都支持，基于DMA-BUF机制，可以实现buffer共享，多用于大内存复杂场景；</li>
<li>fence：buffer同步机制，基于内核dma_fence机制实现，用于防止显示内容出现异步问题；</li>
</ul>
</li>
</ul>
<div align="center">

<h3 id="2-从最简单的DRM应用程序入手-plane-legacy"><a href="#2-从最简单的DRM应用程序入手-plane-legacy" class="headerlink" title="2.从最简单的DRM应用程序入手(plane) (legacy)"></a>2.从最简单的DRM应用程序入手(plane) (legacy)</h3></div>

<ul>
<li><p>什么是plane？</p>
<blockquote>
<p>RM中的Plane指的是Display Controller中用于多层合成的单个硬件图层模块，属于硬件层面。plane是连接fb与crtc的纽带，是内存的搬运工。<br>上图：</p>
</blockquote>
<p><img src="/images/fb-plane.png" srcset="/img/loading.gif" lazyload alt="fb-plane"></p>
<blockquote>
<p>以framebuffer为图源，利用drmModeSetPlane函数设置plane。</p>
</blockquote>
<blockquote>
<p>当 SRC 与 CRTC 的 X&#x2F;Y 不相等时，则实现了平移的效果；</p>
</blockquote>
<blockquote>
<p>当 SRC 与 CRTC 的 W&#x2F;H 不相等时，则实现了缩放的效果；</p>
</blockquote>
<blockquote>
<p>当 SRC 与 FrameBuffer 的 W&#x2F;H 不相等时，则实现了裁剪的效果；</p>
</blockquote>
<ul>
<li>一个高级plane通常具有如下功能</li>
</ul>
<table>
<thead>
<tr>
<th align="center">功能</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">crop</td>
<td align="center">裁剪 如上图</td>
</tr>
<tr>
<td align="center">scaling</td>
<td align="center">缩放 放大或者缩小</td>
</tr>
<tr>
<td align="center">rotation</td>
<td align="center">旋转 90 180 270 X&#x2F;Y镜像</td>
</tr>
<tr>
<td align="center">z-order</td>
<td align="center">z-顺序 调整当前plane在所有图层中的顺序</td>
</tr>
<tr>
<td align="center">blending</td>
<td align="center">合成 pixel alpha&#x2F;global alpha</td>
</tr>
<tr>
<td align="center">format</td>
<td align="center">颜色格式,ARGB888 XRGB888 YUV240等</td>
</tr>
</tbody></table>
<ul>
<li>plane的类型</li>
</ul>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">cursor</td>
<td align="center">光标图层 一般用于pc系统，用于显示鼠标</td>
</tr>
<tr>
<td align="center">overlay</td>
<td align="center">叠加图层 通常用于YUV格式的视频图层</td>
</tr>
<tr>
<td align="center">primary</td>
<td align="center">主要图层 通常用于仅支持RGB格式的简单图层</td>
</tr>
</tbody></table>
<blockquote>
<p>DRM框架规定 任何一个CRTC，必须要有一个primary plane</p>
</blockquote>
</li>
</ul>
<p>legacy版本的简单plane显示代码流程如下</p>
<ol>
<li><p>定义一个buffer_obj:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buffer_object</span> &#123;</span><br><span class="hljs-type">uint32_t</span> width;<br><span class="hljs-type">uint32_t</span> height;<br><span class="hljs-type">uint32_t</span> pitch;<br><span class="hljs-type">uint32_t</span> handle;<br><span class="hljs-type">uint32_t</span> size;<br><span class="hljs-type">uint8_t</span> *vaddr;   <span class="hljs-comment">//物理内存映射后的地址</span><br><span class="hljs-type">uint32_t</span> fb_id;   <br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buffer_object</span> <span class="hljs-title">buf</span>;</span><br></code></pre></td></tr></table></figure></li>
<li><p>打开显示设备<br><code>int fd = open(&quot;/dev/dri/card0&quot;, O_RDWR);</code></p>
</li>
<li><p>获取显示资源，包括crtc、encoder和connector信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drmModeRes</span> *<span class="hljs-title">res</span> =</span> drmModeGetResources(fd);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">获取crtc id和connector id，res中包含各个显示元素信息，且crtc和connector可能不止一个</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">uint32_t</span> conn_id = res-&gt;connectors[<span class="hljs-number">0</span>];<br><span class="hljs-type">uint32_t</span> crtc_id = res-&gt;crtcs[<span class="hljs-number">0</span>];<br></code></pre></td></tr></table></figure></li>
<li><p>获取plane有关设备</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//必须设置DRM_CLIENT_CAP_UNIVERSAL_PLANES，如果不设置，drmModeGetPlaneResources只会返回verlay plane，如果设置则会返回所有的支持的plane资源</span><br>drmSetClientCap(fd, DRM_CLIENT_CAP_UNIVERSAL_PLANES, <span class="hljs-number">1</span>);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drmModePlaneRes</span> *<span class="hljs-title">plane_res</span> =</span> drmModeGetPlaneResources(fd);   <span class="hljs-comment">//获取plane资源列表</span><br><span class="hljs-type">uint32_t</span> plane_id = plane_res-&gt;planes[<span class="hljs-number">0</span>];<br></code></pre></td></tr></table></figure></li>
<li><p>通过conn_id获取connector，connector中包含显示设备的信息，用显示设备的信息初始化buf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">srmModeConnector</span> *<span class="hljs-title">conn</span> =</span> drmModeGetConnector(fd, conn_id);<br>buf.width = conn-&gt;modes[<span class="hljs-number">0</span>].hdisplay;<br>buf.height = conn-&gt;modes[<span class="hljs-number">0</span>].vdisplay;<br></code></pre></td></tr></table></figure></li>
<li><p>根据buf创建framebuffer</p>
<ul>
<li>(1)根据buf创建一个dumb buf   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_mode_create_dumb</span> <span class="hljs-title">create</span>;</span><br>create.width = buf.width;<br>create.height = buf.height;<br>create.bpp = <span class="hljs-number">32</span>;    <span class="hljs-comment">//bpp-bits per pixel</span><br>drmIoctl(fd, DRM_IOCTL_MODE_CREATE_DUMB, &amp;create); <span class="hljs-comment">//为create创建dumb 内存，同时creat得到初始化</span><br></code></pre></td></tr></table></figure></li>
<li>(2)创建一个framebuffer  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//将create初始化后的值反赋给buf</span><br>buf.pitch = create.pitch;<br>buf.size = create.size;<br>buf.handle = create.handle;<br>drmModeAddFB(fd, buf.width, buf.height, <span class="hljs-number">24</span>, <span class="hljs-number">32</span>, buf.pitch, buf.handle, &amp;buf.fb_id);<br></code></pre></td></tr></table></figure></li>
<li>(3)将dumb buffer映射到userspace  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_mode_map_dumb</span> <span class="hljs-title">map</span>;</span><br>   <span class="hljs-built_in">map</span>.handle = create.handle;<br>drmIoctl(fd, DRM_IOCTL_MODE_MAP_DUMB, &amp;<span class="hljs-built_in">map</span>);   <span class="hljs-comment">//映射一个用于CPU访问的dumb buffer</span><br>buf.vaddr = mmap(<span class="hljs-number">0</span>, create.size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-built_in">map</span>.offset); <span class="hljs-comment">//将dumb buffer映射到用户空间</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>通过映射的内存地址画framebuffer</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">memset</span>(buf.vaddr, <span class="hljs-number">0xff</span>, buf.size); <span class="hljs-comment">//画白色</span><br></code></pre></td></tr></table></figure></li>
<li><p>设置crtc，实现显示framebuffer</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">drmModeSetCrtc(fd, crtc_id, buf.fb_id, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;conn_id, <span class="hljs-number">1</span>, &amp;conn-&gt;modes[<span class="hljs-number">0</span>]);<br></code></pre></td></tr></table></figure></li>
<li><p>从framebuffer(100,150)位置crop一个320x320的plane放到crtc上,显示plane</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">drmModeSetPlane(fd, plane_id, crtc_id, buf.fb_id, <span class="hljs-number">0</span>,<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">320</span>, <span class="hljs-number">320</span>, <span class="hljs-number">100</span> &lt;&lt; <span class="hljs-number">16</span>, <span class="hljs-number">150</span> &lt;&lt; <span class="hljs-number">16</span>, <span class="hljs-number">320</span> &lt;&lt; <span class="hljs-number">16</span>, <span class="hljs-number">320</span> &lt;&lt; <span class="hljs-number">16</span>);<br></code></pre></td></tr></table></figure>
<p>drmModeSetPlane函数原型为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">drmModeSetPlane</span> <span class="hljs-params">( <span class="hljs-type">int</span> fd, <span class="hljs-type">uint32_t</span> plane_id, <span class="hljs-type">uint32_t</span> crtc_id, <span class="hljs-type">uint32_t</span> fb_id, <span class="hljs-type">uint32_t</span> flags, <span class="hljs-type">uint32_t</span> crtc_x, <span class="hljs-type">uint32_t</span> crtc_y, <span class="hljs-type">uint32_t</span> crtc_w, <span class="hljs-type">uint32_t</span> crtc_h, <span class="hljs-type">uint32_t</span> src_x, <span class="hljs-type">uint32_t</span> src_y, <span class="hljs-type">uint32_t</span> src_w, <span class="hljs-type">uint32_t</span> src_h )</span><br><span class="hljs-comment">/******</span><br><span class="hljs-comment">     fd:打开的DRM设备的文件描述符。</span><br><span class="hljs-comment">     plane_id:平面需要修改的平面ID。</span><br><span class="hljs-comment">     crtc_id:CRTC该平面所在CRTC的ID。</span><br><span class="hljs-comment">     fb_id:Framebuffer在平面上显示的Framebuffer ID，或-1表示保持Framebuffer不变。</span><br><span class="hljs-comment">     flags:控制函数行为的标志。目前不支持外部使用标志。</span><br><span class="hljs-comment">     crtc_x:从有源显示区域左侧显示平面的偏移量</span><br><span class="hljs-comment">     crtc_y:从有源显示区域顶部到显示平面的偏移量。</span><br><span class="hljs-comment">     crtc_w:显示输出矩形的宽度。</span><br><span class="hljs-comment">     crtc_h:显示输出矩形的高度</span><br><span class="hljs-comment">     src_x:从源framebuffer左侧的剪辑偏移量(Q16.16固定点)。</span><br><span class="hljs-comment">     src_y:来自源framebuffer顶部的剪辑偏移量(Q16.16固定点)。</span><br><span class="hljs-comment">     src_w:源矩形的宽度(Q16.16固定点)。</span><br><span class="hljs-comment">     src_h:源矩形的高度(Q16.16固定点)。</span><br><span class="hljs-comment"> ***/</span><br></code></pre></td></tr></table></figure></li>
<li><p>完成显示后释放资源</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">modeset_destroy_fb(fd, &amp;buf);<br>drmModeFreeConnector(conn);<br>drmModeFreePlaneResources(plane_res);<br>drmModeFreeResources(res);<br>close(fd);<br></code></pre></td></tr></table></figure></li>
</ol>
<div align="center">

<h3 id="3-property简述"><a href="#3-property简述" class="headerlink" title="3.property简述"></a>3.property简述</h3><blockquote>
<p>property是atomic接口必须依赖的基本元素</p>
</blockquote>
</div>

<ul>
<li><p>property：</p>
<ul>
<li>把legacy接口传入的参数做成一个个独立的全局属性，通过设置这些属性参数，可以完成对显示参数的设置；</li>
<li>property由name、id、value三部分组成。其中id为该property在DRM框架中唯一的标识符；</li>
<li>property机制的好处：<ul>
<li>减少上层应用接口的维护工作量；添加新功能时无需增加新的函数和IOCTL，只需要在底层中新增一个property，然后在应用程序中获取&#x2F;操作property即可；</li>
<li>增加了参数设置的灵活性；一次IOCTL可以同时设置多个property，减少了usersapce与kernel的切换次数。</li>
</ul>
</li>
</ul>
</li>
<li><p>常用的property</p>
<ul>
<li>crtc相关</li>
</ul>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ACTIVE</td>
<td align="center">crtc当前的使能状态，一般用于CRTC上下电</td>
</tr>
<tr>
<td align="center">MODE_ID</td>
<td align="center">crtc当前使用的display mode id，通过该id可以找到具体的display mode参数</td>
</tr>
<tr>
<td align="center">OUT_FENCE_PTR</td>
<td align="center">输出fence指针，指向当前正在显示的buffer所对应的fence id，该fence由DRM驱动创建，供上层应用使用，用来表示当前buffer crtc是否还在占用</td>
</tr>
</tbody></table>
<ul>
<li>plane相关</li>
</ul>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">type</td>
<td align="center">plane的类型，CURSOR、PRIMARY或者OVERLAY</td>
</tr>
<tr>
<td align="center">FB_ID</td>
<td align="center">与当前plane绑定的framebuffer object ID</td>
</tr>
<tr>
<td align="center">IN_FENCE_FD</td>
<td align="center">与当前plane相关联的input fence fd，由buffer的生产者创建，供DRM底层驱动使用，用来标识当前传下来的buffer是否可以开始访问</td>
</tr>
<tr>
<td align="center">CRTC_ID</td>
<td align="center">当前plane所关联的CRTC object ID，与CONNECTOR中的CRTC_ID属性是同一个property</td>
</tr>
<tr>
<td align="center">SRC_X</td>
<td align="center">当前framebuffer crop区域的起始偏移x坐标</td>
</tr>
<tr>
<td align="center">SRC_Y</td>
<td align="center">当前framebuffer crop区域的起始偏移y坐标</td>
</tr>
<tr>
<td align="center">SRC_W</td>
<td align="center">当前framebuffer crop区域的宽度</td>
</tr>
<tr>
<td align="center">SRC_H</td>
<td align="center">当前framebuffer crop区域的高度</td>
</tr>
<tr>
<td align="center">CRTC_X</td>
<td align="center">屏幕显示区域的起始偏移x坐标</td>
</tr>
<tr>
<td align="center">CRTC_Y</td>
<td align="center">屏幕显示区域的起始偏移y坐标</td>
</tr>
<tr>
<td align="center">CRTC_W</td>
<td align="center">屏幕显示区域的宽度</td>
</tr>
<tr>
<td align="center">CRTC_H</td>
<td align="center">屏幕显示区域的高度</td>
</tr>
<tr>
<td align="center">IN_FORMATS</td>
<td align="center">用于标识特殊的颜色存储格式，如AFBC、IFBC存储格式，该属性为只读</td>
</tr>
<tr>
<td align="center">rotation</td>
<td align="center">当前图层的旋转角度</td>
</tr>
<tr>
<td align="center">zposition</td>
<td align="center">当前图层在所有图层中的Z轴顺序</td>
</tr>
<tr>
<td align="center">alpha</td>
<td align="center">当前图层的global alpha（非pixel alpha），用于多层合成</td>
</tr>
<tr>
<td align="center">pixel blend mode</td>
<td align="center">当前图层的合成方式，如Pre-multiplied&#x2F;Coverage等</td>
</tr>
</tbody></table>
<ul>
<li>connector相关</li>
</ul>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">EDID</td>
<td align="center">Extended Display Identification Data，标识显示器的参数信息，是一种VESA标准数据格式</td>
</tr>
<tr>
<td align="center">DPMS</td>
<td align="center">Display Power Management Signaling，用于控制显示器的电源状态，如休眠唤醒。也是一种VESA标准</td>
</tr>
<tr>
<td align="center">link-status</td>
<td align="center">用于标识当前connector的连接状态，如Good&#x2F;Bad</td>
</tr>
<tr>
<td align="center">CRTC_ID</td>
<td align="center">当前connector所连接的CRTC object ID，与PLANE中CRTC_ID属性是同一个property</td>
</tr>
<tr>
<td align="center">PATH</td>
<td align="center">DisplayPort专用的属性，主要用于Multi-Stream Transport (MST) 功能，即多路显示应用场景</td>
</tr>
<tr>
<td align="center">TILE</td>
<td align="center">用于标识当前connector是否应用于多屏拼接场景，如平时随处可见的多屏拼接显示的广告大屏幕</td>
</tr>
</tbody></table>
</li>
<li><p>property的类型</p>
<ul>
<li><mark>DRM_MODE_PROP_RANGE</mark>：range property会report它们可接受的最大值和最小值范围(unsigned value)，KMS内核验证app设定的值是否符合这个范围。范围属性由drm_property_create_range()函数创建;</li>
<li><mark>DRM_MODE_PROP_SIGNED_RANGE</mark>：range property会report它们可接受的最大值和最小值范围(signed value)，KMS内核验证app设定的值是否符合这个范围。范围属性由drm_property_create_signed_range()函数创建;</li>
<li><mark>DRM_MODE_PROP_ENUM</mark>：Enumerated properties(枚举属性)限定一个范围，从0到属性定义的值减1，每个值有一个字符串符号，应用程序可以通过检索值-名称列表，使用数值来获取或者设置属性实例的值。枚举属性由drm_property_create_enum()函数创建；</li>
<li><mark>DRM_MODE_PROP_BITMASK</mark>：Bitmask properties（位掩码属性），其实就是将所有枚举值范围限定在0-63的枚举值属性，bitmask property的值将属性定义的一个或者多个枚举位组合表示，位掩码属性由drm_property_create_bitmask()函数创建；</li>
<li><mark>DRM_MODE_PROP_OBJECT</mark>：object property与modeset_object联系，在atomic中广泛使用，通过链接&amp;drm_frmaebuffer和&amp;drm_plane,链接&amp;drm_plane和&amp;drm_crtc，链接&amp;drm_crtc和&amp;drm_connector创建display_pipeline，Object property由drm_property_create_object()函数创建；</li>
<li><mark>DRM_MODE_PROP_BLOB</mark>：blob property存储一段没有格式限制的二进制blob，它的值表示它链接的blob obj的id，blob property由drm_property_create()函数使用DRM_MODE_PROP_BLOB类型参数创建，带blob数据的blob obj由drm_property_create_blob()创建；</li>
<li><mark>DRM_MODE_PROP_ATOMIC</mark>：为atomic模式的属性设置，这些属性不会暴露给legacy 用户空间；</li>
<li><mark>DRM_MODE_PROP_IMMUTABLE</mark>：为用户空间无法改变其值的属性设置，kernel可以改变这些属性的值，通过drm_object_property_set_value()函数；</li>
</ul>
</li>
</ul>
<div align="center">

<h3 id="4-atomic-crtc显示简单示例-property"><a href="#4-atomic-crtc显示简单示例-property" class="headerlink" title="4.atomic-crtc显示简单示例 (property)"></a>4.atomic-crtc显示简单示例 (property)</h3></div>

<blockquote>
<p>利用libdrm提供的atomic接口，通过name来获取property，通过id操作property，通过value修改property</p>
</blockquote>
<p><mark>第1-6步与legacy plane应用程序中步骤相同</mark></p>
<ol>
<li><p>创建buffer</p>
</li>
<li><p>获取资源，ctrc、connector、encoder</p>
</li>
<li><p>获取plane资源</p>
</li>
<li><p>获取connector并且根据其值初始化buffer</p>
</li>
<li><p>根据buffer创建framebuffer</p>
</li>
<li><p>通过映射的内存地址画framebuffer</p>
</li>
<li><p>告知DRM驱动该应用程序支持atomic操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">drmSetClientCap(fd, DRM_CLIENT_CAP_ATOMIC, <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure></li>
<li><p>获取connector properties</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drmModeObjectProperties</span> *<span class="hljs-title">props</span> =</span> drmModeObjectGetProperties(fd, conn_id,	DRM_MODE_OBJECT_CONNECTOR);<br><span class="hljs-type">uint32_t</span> property_crtc_id = get_property_id(fd, props, <span class="hljs-string">&quot;CRTC_ID&quot;</span>);  <span class="hljs-comment">//与connector关联的crtc_id</span><br>drmModeFreeObjectProperties(props);    <span class="hljs-comment">//释放props</span><br></code></pre></td></tr></table></figure></li>
<li><p>获取crtc properties</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">props = drmModeObjectGetProperties(fd, crtc_id, DRM_MODE_OBJECT_CRTC);<br><span class="hljs-type">uint32_t</span> property_active = get_property_id(fd, props, <span class="hljs-string">&quot;ACTIVE&quot;</span>); <span class="hljs-comment">//获取crtc active属性</span><br><span class="hljs-type">uint32_t</span> property_mode_id = get_property_id(fd, props, <span class="hljs-string">&quot;MODE_ID&quot;</span>); <span class="hljs-comment">//获取crtc使用的display mode id</span><br>drmModeFreeObjectProperties(props);  <span class="hljs-comment">//释放props</span><br></code></pre></td></tr></table></figure></li>
<li><p>创建blob property储存现在的模式，并保存blob id</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint32_t</span> blob_id;<br>drmModeCreatePropertyBlob(fd, &amp;conn-&gt;modes[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span>(conn-&gt;modes[<span class="hljs-number">0</span>]), &amp;blob_id);<br></code></pre></td></tr></table></figure></li>
<li><p>mode setting 替代从前的drmModeSetCrtc代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drmModeAtomicReq</span> *<span class="hljs-title">req</span>;</span><br>   req = drmModeAtomicAlloc();  <span class="hljs-comment">//创建atomic请求对象</span><br>drmModeAtomicAddProperty(req, crtc_id, property_active, <span class="hljs-number">1</span>);  <span class="hljs-comment">//设置crtc的property_active值</span><br>drmModeAtomicAddProperty(req, crtc_id, property_mode_id, blob_id);  <span class="hljs-comment">//设置crtc的property_mode_id值</span><br>drmModeAtomicAddProperty(req, conn_id, property_crtc_id, crtc_id);  <span class="hljs-comment">//设置connector的property_crtc_id值</span><br>drmModeAtomicCommit(fd, req, DRM_MODE_ATOMIC_ALLOW_MODESET, <span class="hljs-literal">NULL</span>);  <span class="hljs-comment">//提交请求</span><br>drmModeAtomicFree(req);  <span class="hljs-comment">//释放请求对象</span><br></code></pre></td></tr></table></figure></li>
<li><p>从framebuffer(100,150)位置crop一个320x320的plane放到crtc上,显示plane</p>
   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">drmModeSetPlane(fd, plane_id, crtc_id, buf.fb_id, <span class="hljs-number">0</span>,<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">320</span>, <span class="hljs-number">320</span>, <span class="hljs-number">100</span> &lt;&lt; <span class="hljs-number">16</span>, <span class="hljs-number">150</span> &lt;&lt; <span class="hljs-number">16</span>, <span class="hljs-number">320</span> &lt;&lt; <span class="hljs-number">16</span>, <span class="hljs-number">320</span> &lt;&lt; <span class="hljs-number">16</span>);<br></code></pre></td></tr></table></figure></li>
<li><p>释放资源</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">   modeset_destroy_fb(fd, &amp;buf);<br>drmModeFreeConnector(conn);<br>drmModeFreePlaneResources(plane_res);<br>drmModeFreeResources(res);<br>close(fd);<br></code></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>第12步仍然使用的是legacy接口drmModeSetPlane()，现在使用atomic接口替换其功能<ul>
<li>12.1 获取plane属性<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">props = drmModeObjectGetProperties(fd, plane_id, DRM_MODE_OBJECT_PLANE);<br><span class="hljs-type">uint32_t</span> property_crtc_id = get_property_id(fd, props, <span class="hljs-string">&quot;CRTC_ID&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_fb_id = get_property_id(fd, props, <span class="hljs-string">&quot;FB_ID&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_crtc_x = get_property_id(fd, props, <span class="hljs-string">&quot;CRTC_X&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_crtc_y = get_property_id(fd, props, <span class="hljs-string">&quot;CRTC_Y&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_crtc_w = get_property_id(fd, props, <span class="hljs-string">&quot;CRTC_W&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_crtc_h = get_property_id(fd, props, <span class="hljs-string">&quot;CRTC_H&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_src_x = get_property_id(fd, props, <span class="hljs-string">&quot;SRC_X&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_src_y = get_property_id(fd, props, <span class="hljs-string">&quot;SRC_Y&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_src_w = get_property_id(fd, props, <span class="hljs-string">&quot;SRC_W&quot;</span>);<br><span class="hljs-type">uint32_t</span> property_src_h = get_property_id(fd, props, <span class="hljs-string">&quot;SRC_H&quot;</span>);<br>drmModeFreeObjectProperties(props);<br></code></pre></td></tr></table></figure></li>
<li>12.2 atomic update plane<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">   req = drmModeAtomicAlloc();<br>drmModeAtomicAddProperty(req, plane_id, property_crtc_id, crtc_id);<br>drmModeAtomicAddProperty(req, plane_id, property_fb_id, buf.fb_id);<br>drmModeAtomicAddProperty(req, plane_id, property_crtc_x, <span class="hljs-number">50</span>);<br>drmModeAtomicAddProperty(req, plane_id, property_crtc_y, <span class="hljs-number">50</span>);<br>drmModeAtomicAddProperty(req, plane_id, property_crtc_w, <span class="hljs-number">320</span>);<br>drmModeAtomicAddProperty(req, plane_id, property_crtc_h, <span class="hljs-number">320</span>);<br>drmModeAtomicAddProperty(req, plane_id, property_src_x, <span class="hljs-number">0</span>);<br>drmModeAtomicAddProperty(req, plane_id, property_src_y, <span class="hljs-number">0</span>);<br>drmModeAtomicAddProperty(req, plane_id, property_src_w, <span class="hljs-number">320</span> &lt;&lt; <span class="hljs-number">16</span>);<br>drmModeAtomicAddProperty(req, plane_id, property_src_h, <span class="hljs-number">320</span> &lt;&lt; <span class="hljs-number">16</span>);<br>drmModeAtomicCommit(fd, req, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>drmModeAtomicFree(req);<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<div align="center">

<h3 id="5-KMS驱动概述"><a href="#5-KMS驱动概述" class="headerlink" title="5.KMS驱动概述"></a>5.KMS驱动概述</h3></div>

<ul>
<li><p>DRM框架核心：</p>
<p><img src="/../images/drm%E9%A9%B1%E5%8A%A8%E6%A0%B8%E5%BF%83.jpg" srcset="/img/loading.gif" lazyload alt="DRM框架核心"></p>
<ul>
<li>上图蓝色部分则是对物理硬件的抽象，黄色部分则是对软件的抽象；</li>
<li>虚线以上的为 drm_mode_object，虚线以下为 drm_gem_object；</li>
</ul>
</li>
<li><p>各个objects之间的关系：<br><img src="/../images/objs%E5%85%B3%E7%B3%BB%E5%9B%BE.png" srcset="/img/loading.gif" lazyload alt="objs结构"></p>
<ul>
<li>plane连接fb和crtc</li>
<li>encoder连接crtc和connector</li>
</ul>
</li>
</ul>
<h4 id="最简单的KMS驱动代码分析-legacy"><a href="#最简单的KMS驱动代码分析-legacy" class="headerlink" title="最简单的KMS驱动代码分析(legacy)"></a>最简单的KMS驱动代码分析(legacy)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drmP.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_gem_cma_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_plane.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_plane_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_crtc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_crtc_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_encoder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_connector.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_probe_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_mode_config.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_gem_framebuffer_helper.h&quot;</span></span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_device</span> <span class="hljs-title">drm</span>;</span>    <span class="hljs-comment">//声明drm设备对象</span><br><br><span class="hljs-comment">/*声明drm_obj*/</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_plane</span> <span class="hljs-title">primary</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc</span> <span class="hljs-title">crtc</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_encoder</span> <span class="hljs-title">encoder</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector</span> <span class="hljs-title">connector</span>;</span><br><br><span class="hljs-comment">/*声明各个obj操作函数集接口*/</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_plane_funcs</span> <span class="hljs-title">vkms_plane_funcs</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc_funcs</span> <span class="hljs-title">vkms_crtc_funcs</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_encoder_funcs</span> <span class="hljs-title">vkms_encoder_funcs</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector_funcs</span> <span class="hljs-title">vkms_connector_funcs</span>;</span><br><br><br><span class="hljs-comment">//mode setting函数集</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_mode_config_funcs</span> <span class="hljs-title">vkms_mode_funcs</span> =</span> &#123;<br>   .fb_create = drm_gem_fb_create,  <span class="hljs-comment">//使用gem helper函数 创建framebuffer object\</span><br><span class="hljs-comment">                                       并绑定gem object，drm_gem_framebuffer_helper.h中声明</span><br>&#125;;<br><br><span class="hljs-comment">/*声明plane支持的fb formats*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> vkms_formats = &#123;<br>   DRM_FORMAT_XRGB8888,<br>&#125;;<br><br><span class="hljs-comment">//crtc funcs 中 page flip函数实现</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">vkms_page_flip</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc, <span class="hljs-keyword">struct</span> drm_framebuffer *fb, \</span><br><span class="hljs-params">                  <span class="hljs-keyword">struct</span> drm_pending_vblank_event *event, \</span><br><span class="hljs-params">                  <span class="hljs-type">uint32_t</span> flags, <span class="hljs-keyword">struct</span> drm_modeset_acquire_ctx *ctx)</span><br>&#123;<br>   <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>   crtc-&gt;primary-&gt;fb = fb;<br>   <span class="hljs-keyword">if</span> (event)     <span class="hljs-comment">//自旋等待vsync事件</span><br>   &#123;    <br>      spin_lock_irqsave(&amp;crtc-&gt;dev-&gt;event_lock, flags);<br>      drm_crtc_send_vblank_event(crtc, event);<br>      spin_unlock_irqrestore(&amp;crtc-&gt;dev-&gt;event_lock, flags);<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//crtc funcs接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc_funcs</span> <span class="hljs-title">vkms_crtc_funcs</span> =</span> &#123;<br>   .set_config = drm_crtc_helper_set_config,           <span class="hljs-comment">//drmModeSetCrtc()会调用此接口，使用helper函数</span><br>   .page_flip = vkms_page_flip,                        <span class="hljs-comment">//drmModePageFlip()会调用此接口</span><br>   .destroy = drm_crtc_cleanup,                        <span class="hljs-comment">//crtc清理函数 crtc funcs中必须有destroy</span><br>&#125;;<br><br><span class="hljs-comment">//crtc helper funcs中dpms的实现 暂为空</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">vkms_crtc_dpms</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc, <span class="hljs-type">int</span> mode)</span><br>&#123;<br><br>&#125;<br><br><span class="hljs-comment">//crtc helper funcs中mode_set的实现 暂为空</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">vkms_crtc_mode_set</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc, <span class="hljs-keyword">struct</span> drm_display_mode *mode,</span><br><span class="hljs-params">         <span class="hljs-keyword">struct</span> drm_display_mode *adjusted_mode, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y,</span><br><span class="hljs-params">         <span class="hljs-keyword">struct</span> drm_framebuffer *old_fb)</span><br>&#123;<br><br>&#125;<br><br><span class="hljs-comment">//crtc helper funcs中mode_set的实现 暂为空</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">vkms_crtc_prepare</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc)</span><br>&#123;<br><br>&#125;<br><br><span class="hljs-comment">//crtc helper funcs中commit的实现 暂为空</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">vkms_crtc_commit</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc)</span><br>&#123;<br><br>&#125;<br><br><span class="hljs-comment">//crtc helper funcs接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc_helper_funcs</span> <span class="hljs-title">vkms_crtc_helper_funcs</span> =</span> &#123;<br>   .dpms = vkms_crtc_dpms,    <span class="hljs-comment">// crtc power levels control</span><br>   .mode_set = vkms_crtc_mode_set,  <span class="hljs-comment">//This callback is used by the legacy CRTC helpers to set a new mode, \</span><br><span class="hljs-comment">                                       position and framebuffer.</span><br>   .prepare = vkms_crtc_prepare, <span class="hljs-comment">//This callback should prepare the CRTC for a subsequent modeset, \</span><br><span class="hljs-comment">                                    which in practice means the driver should disable the CRTC if it isrunning.</span><br>   .commit = vkms_crtc_commit,    <span class="hljs-comment">//This callback should commit the new mode on the CRTC after a modeset,\</span><br><span class="hljs-comment">                                 which in practice means the driver should enable the CRTC.</span><br>&#125;;<br><br><span class="hljs-comment">//plane funcs 接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_plane_funcs</span> <span class="hljs-title">vkms_plane_funcs</span> =</span> drm_primary_helper_funcs;  <span class="hljs-comment">//drm_plane_helper.h中声明 drm_plane_helper.c中定义\</span><br><span class="hljs-comment">                                                                           包括update_plane disable_plane destroy三个成员的实现\</span><br><span class="hljs-comment">                                                                           update 在drmModeSetPlane()调用</span><br><br><span class="hljs-comment">//connector funcs 接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector_funcs</span> <span class="hljs-title">vkms_connector_funcs</span> =</span> &#123;<br>   .dpms = drm_helper_connector_dpms,<br>   .fill_modes = drm_helper_probe_single_connector_modes,    <span class="hljs-comment">//drm_probe_helper.c中实现  由drmModeGetConnector()调用</span><br>   .destroy = drm_connector_cleanup,<br>&#125;;<br><br><span class="hljs-comment">//connector helper funcs 中 get_modes实现</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">vkms_connector_get_modes</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_connector *connector)</span><br>&#123;<br>   <span class="hljs-type">int</span> count;<br>   count = drm_add_modes_noedid(connector, <span class="hljs-number">8192</span>, <span class="hljs-number">8192</span>);<br>   drm_set_preferred_mode(connector, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>);<br>   <span class="hljs-keyword">return</span> count;<br>&#125;<br><br><span class="hljs-comment">//connector helper funcs 中 best_encoder实现</span><br><span class="hljs-keyword">struct</span> drm_encoder *<span class="hljs-title function_">vkms_connector_best_encoder</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_connector *connector)</span><br>&#123;<br>   <span class="hljs-keyword">return</span> &amp;encoder;<br>&#125;<br><span class="hljs-comment">//connector helper funcs 接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector_helper_funcs</span> <span class="hljs-title">vkms_connector_helper_funcs</span> =</span> &#123;<br>   .get_modes = vkms_connector_get_modes,   <span class="hljs-comment">//Add modes to the connector that the panel is attached to and \</span><br><span class="hljs-comment">                                             return the number of modes added.</span><br>   .best_encoder = vkms_connector_best_encoder,  <span class="hljs-comment">//Encoder that should be used for the given connector and connector \</span><br><span class="hljs-comment">                                                   state, or NULL if no suitable encoder exists.</span><br>&#125;;<br><br><br><span class="hljs-comment">//encoder funcs接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_encoder_funcs</span> <span class="hljs-title">vkms_encoder_funcs</span> =</span> &#123;<br>   .destroy = drm_encoder_cleanup,<br>&#125;;<br><br><span class="hljs-comment">/*初始化各个obj*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vkms_modeset_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>   drm_mode_config_init(&amp;drm);  <span class="hljs-comment">//初始化一些全局数据结构，standard properties在此处创建</span><br><br>   drm.mode_config.max_width = <span class="hljs-number">2048</span>;<br>   drm.mode_config.max_height = <span class="hljs-number">2048</span>;<br><br>   drm.mode_config.funcs = &amp;vkms_mode_funcs;   <span class="hljs-comment">//设置mode config函数集</span><br><br>   <span class="hljs-comment">/*创建drm_mode_objects*/</span><br>   drm_universal_plane_init(&amp;drm, &amp;primary, <span class="hljs-number">0</span>, &amp;vkms_plane_funcs, vkms_formats, \<br>   ARRAY_SIZE(vkms_formats), <span class="hljs-literal">NULL</span>, DRM_PLANE_TYPE_PRIMARY, <span class="hljs-literal">NULL</span>);<br>   drm_crtc_init_with_planes(&amp;drm, &amp;crtc, &amp;primary, <span class="hljs-literal">NULL</span>, &amp;vkms_crtc_funcs, <span class="hljs-literal">NULL</span>);<br>   drm_crtc_helper_add(&amp;crtc, &amp;vkms_crtc_helper_funcs);<br>   drm_encoder_init(&amp;drm, &amp;encoder, &amp;vkms_encoder_funcs, DRM_MODE_ENCODER_VIRTUAL, <span class="hljs-literal">NULL</span>);<br>   drm_connector_init(&amp;drm, &amp;connector, &amp;vkms_connector_funcs, DRM_MODE_CONNECTOR_VIRTUAL);<br>   drm_connector_helper_add(&amp;connector, &amp;vkms_connector_helper_funcs);<br>   drm_connector_attach_encoder(&amp;connector, &amp;encoder);<br>&#125;<br><br><br>DEFINE_DRM_GEM_CMA_FOPS(drm_driver_fops);   <span class="hljs-comment">//drm_gem_cma_helper.h中已经帮忙定义好了\</span><br><span class="hljs-comment">                                             drm driver的相关fops接口，drm_driver_fops为自定义的fops名</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_driver</span> <span class="hljs-title">vkms_driver</span> =</span> &#123;    <span class="hljs-comment">//drm driver</span><br>   .name = <span class="hljs-string">&quot;vkms&quot;</span>, <br>   .desc = <span class="hljs-string">&quot;virtual kernel mode setting&quot;</span>,<br>   .date = <span class="hljs-string">&quot;2022.10.27&quot;</span>,<br>   .major = <span class="hljs-number">1</span>,<br>   .minor = <span class="hljs-number">0</span>,<br>   .driver_features = DRIVER_MODESET | DRIVER_GEM,     <span class="hljs-comment">//驱动支持的操作:mode setting, gem</span><br>   .fops = drm_driver_fops,<br>   .dumb_create = drm_gem_cma_dumb_create,  <span class="hljs-comment">//用于创建gem object并分配物理buffer，直接使用cma helper函数</span><br>&#125;;<br><br><br><span class="hljs-comment">/**模块入口**/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">vkms_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>   <span class="hljs-comment">/****</span><br><span class="hljs-comment">   * 初始化drm_dev设备;</span><br><span class="hljs-comment">   * 将drm device和driver关联</span><br><span class="hljs-comment">   * 此函数会使drm_device结构体下的driver成员变量指向drm_driver</span><br><span class="hljs-comment">   */</span><br>   drm_dev_init(&amp;drm, &amp;vkms_driver, <span class="hljs-literal">NULL</span>);<br><br>   vkms_modeset_init();<br><br>   drm_dev_register(&amp;drm, <span class="hljs-number">0</span>); <span class="hljs-comment">//将drm dev注册进drm core</span><br>&#125;<br><br><span class="hljs-comment">/*模块出口*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">vkms_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><br>&#125;<br><br>module_init(vkms_init);<br>module_exit(vkms_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;Hector&quot;</span>);  <br></code></pre></td></tr></table></figure>

<ol>
<li>定义drm设备对象和drm_mode_objects(crtc plane encoder connector);</li>
<li>创建驱动核心drm_driver，设置其相关information和features;</li>
<li>完成driver相关的fops，使用DEFINE_DRM_GEM_CMA_FOPS(drm_driver_fops);</li>
<li>完成mode_config_funcs；</li>
<li>完成各个object的drm_xxx_funcs和drm_xxx_helper_funcs</li>
<li>drm_dec_init</li>
<li>drm_mode_config_init,完成设备的modeconfig设置</li>
<li>用drm_xxx_funcs创建各个drm_mode_objects,利用drm_xxx_helper_add绑定各个drm_xxx_helper_funcs</li>
<li>drm_dev_register</li>
</ol>
<blockquote>
<p>以上为legacy接口驱动，且为最简单的驱动实现，各个drm_xxx_funcs和drm_xxx_helper_funcs无法更精简</p>
</blockquote>
<blockquote>
<p>drm_xxx_funcs 是 drm ioctl 操作的最终入口，但是对于大多数 SoC 厂商来说，它们的 drm_xxx_funcs 操作流程基本相同，只是在寄存器配置上存在差异，因此开发者们将那些 common 的操作流程做成了 helper 函数，而将那些厂商差异化的代码放到了 drm_xxx_helper_funcs 中去，由 SoC 厂商自己实现。</p>
</blockquote>
<ul>
<li>legacy接口重点<ul>
<li>xxx_funcs必须有，xxx_helper_funcs可以没有</li>
<li>drm_xxx_init必须有，drm_xxx_helper_add()取决于是否有xxx_helper_funcs</li>
<li>只有当xxx_funcs采用DRM标准的helper函数实现时才有可能需要定义xxx_helper_funcs接口</li>
<li>xxx_funcs.destroy()接口必须实现</li>
</ul>
</li>
</ul>
<h4 id="最简单的KMS驱动代码分析-atomic"><a href="#最简单的KMS驱动代码分析-atomic" class="headerlink" title="最简单的KMS驱动代码分析(atomic)"></a>最简单的KMS驱动代码分析(atomic)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drmP.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_gem_cma_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_plane.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_plane_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_crtc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_crtc_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_encoder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_connector.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_probe_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_mode_config.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_gem_framebuffer_helper.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;linux/hrtimer.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;drm/drm_atomic_helper.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_device</span> <span class="hljs-title">drm</span>;</span>    <span class="hljs-comment">//声明drm设备对象</span><br><br><span class="hljs-comment">/*声明drm_obj*/</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_plane</span> <span class="hljs-title">primary</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc</span> <span class="hljs-title">crtc</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_encoder</span> <span class="hljs-title">encoder</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector</span> <span class="hljs-title">connector</span>;</span><br><br><span class="hljs-comment">/*声明各个obj操作函数集接口*/</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_plane_funcs</span> <span class="hljs-title">vkms_plane_funcs</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc_funcs</span> <span class="hljs-title">vkms_crtc_funcs</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_encoder_funcs</span> <span class="hljs-title">vkms_encoder_funcs</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector_funcs</span> <span class="hljs-title">vkms_connector_funcs</span>;</span><br><br><span class="hljs-comment">//vblank依赖的高精度定时器</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hrtimer</span> <span class="hljs-title">vblank_timer</span>;</span><br><br><span class="hljs-comment">//定时器回调函数</span><br><span class="hljs-keyword">enum</span> hrtimer_restart <span class="hljs-title function_">vkms_vblank_timer_function</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> hrtimer *)</span><br>&#123;<br>    drm_crtc_handle_vblank(&amp;crtc);   <span class="hljs-comment">//Drivers should call this routine in their vblank interrupt handlers to \</span><br><span class="hljs-comment">                                        update the vblank counter and send any signals that may be pending.</span><br>    hrtimer_forward_now(&amp;vblank_hrtimer, <span class="hljs-number">16666667</span>);  <span class="hljs-comment">//重新设置定时器的触发时间，相当于重复使用定时器</span><br>    <span class="hljs-keyword">return</span> HRTIMER_RESTART;<br>&#125;<br><br><br><span class="hljs-comment">//mode setting函数集</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_mode_config_funcs</span> <span class="hljs-title">vkms_mode_funcs</span> =</span> &#123;<br>    .fb_create = drm_gem_fb_create,  <span class="hljs-comment">//使用gem helper函数 创建framebuffer object\</span><br><span class="hljs-comment">                                        并绑定gem object，drm_gem_framebuffer_helper.h中声明</span><br>    .<span class="hljs-type">atomic_check</span> = drm_atomic_helper_check,  <span class="hljs-comment">//检查硬件或者驱动是否支持atomic操作</span><br>    .<span class="hljs-type">atomic_commit</span> = drm_atomic_helper_commit,  <span class="hljs-comment">//This is the only hook to commit an atomic modeset update.</span><br>&#125;;<br><br><span class="hljs-comment">/*声明plane支持的fb formats*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> vkms_formats = &#123;<br>    DRM_FORMAT_XRGB8888,<br>&#125;;<br><br><br><span class="hljs-comment">//crtc funcs接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc_funcs</span> <span class="hljs-title">vkms_crtc_funcs</span> =</span> &#123;<br>    .set_config = drm_atomic_helper_set_config,     <br>    .page_flip = drm_atomic_helper_page_flip,<br>    .reset = drm_atomic_helper_crtc_reset,<br>    .atomic_duplicate_state = drm_atomic_helper_crtc_duplicate_state,  <span class="hljs-comment">//Duplicated atomic state or NULL when the allocation failed</span><br>    .atomic_destroy_state = drm_atomic_helper_crtc_destroy_state,    <span class="hljs-comment">//Destroy a state duplicated with @atomic_duplicate_state and release \                                                                    or unreference all resources it references                </span><br>    .destroy = drm_crtc_cleanup,       <br>&#125;;<br><br><br><span class="hljs-comment">//crtc helper funcs中atomic enable的实现</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vkms_crtc_atomic_enable</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc, <span class="hljs-keyword">struct</span> drm_crtc_state *old_crtc_state)</span><br>&#123;<br>    hrtimer_init(&amp;vblank_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);   <span class="hljs-comment">//初始化定时器</span><br>    vblank_timer.function = vkms_vblank_timer_function;       <span class="hljs-comment">//定时器回调函数</span><br>    hrtimer_start(&amp;vblank_timer, <span class="hljs-number">16666667</span>, HRTIMER_MODE_REL); <br>&#125;<br><br><span class="hljs-comment">//crtc helper funcs中atomic disable的实现</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vkms_crtc_atomic_disable</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc, <span class="hljs-keyword">struct</span> drm_crtc_state *old_crtc_state)</span><br>&#123;<br>    hrtimer_cancel(&amp;vblank_timer);    <span class="hljs-comment">//等待回调函数执行完取消定时器</span><br>&#125;<br><br><span class="hljs-comment">//crtc helper funcs中atomic flush的实现</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vkms_crtc_atomic_flush</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_crtc *crtc, <span class="hljs-keyword">struct</span> drm_crtc_state *old_crtc_state)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	<span class="hljs-keyword">if</span> (crtc-&gt;state-&gt;event) &#123;<br>		spin_lock_irqsave(&amp;crtc-&gt;dev-&gt;event_lock, flags);<br>		drm_crtc_send_vblank_event(crtc, crtc-&gt;state-&gt;event);<br>		spin_unlock_irqrestore(&amp;crtc-&gt;dev-&gt;event_lock, flags);<br><br>		crtc-&gt;state-&gt;event = <span class="hljs-literal">NULL</span>;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">//crtc helper funcs接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_crtc_helper_funcs</span> <span class="hljs-title">vkms_crtc_helper_funcs</span> =</span> &#123;<br>    .<span class="hljs-type">atomic_enable</span> = vkms_crtc_atomic_enable,    <span class="hljs-comment">//This callback should be used to enable the CRTC.</span><br>    .atomic_disable = vkms_crtc_atomic_disable,  <span class="hljs-comment">//This callback should be used to disable the CRTC.</span><br>    .<span class="hljs-type">atomic_flush</span> = vkms_crtc_atomic_flush,      <span class="hljs-comment">//Drivers should finalize an atomic update of multiple planes on a CRTC in this hook. </span><br>&#125;;<br><br><span class="hljs-comment">//plane funcs 接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_plane_funcs</span> <span class="hljs-title">vkms_plane_funcs</span> =</span> &#123;<br>    .update_plane = drm_atomic_helper_update_plane,<br>    .disable_plane = drm_atomic_helper_disable_plane,<br>    .destroy = drm_plane_cleanup,<br>    .reset = drm_atomic_helper_plane_reset,<br>    .atomic_duplicate_state = drm_atomic_helper_plane_duplicate_state,<br>    .atomic_destroy_state = drm_atomic_helper_plane_destroy_state,<br>&#125;;<br><br><span class="hljs-comment">//plane helper funcs中的atomic_update实现 暂为空</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vkms_plane_atomic_update</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_plane *plane, <span class="hljs-keyword">struct</span> drm_plane_state *old_state)</span><br>&#123;<br><br>&#125;<br><br><span class="hljs-comment">//plane helper funcs接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_plane_helper_funcs</span> <span class="hljs-title">vkms_plane_helper_funcs</span> =</span> &#123;<br>    .<span class="hljs-type">atomic_update</span> = vkms_plane_atomic_update,  <span class="hljs-comment">//Drivers should use this function to update the plane state.</span><br>&#125;; <br><br><span class="hljs-comment">//connector funcs 接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector_funcs</span> <span class="hljs-title">vkms_connector_funcs</span> =</span> &#123;<br>    .fill_modes = drm_helper_probe_single_connector_modes,    <span class="hljs-comment">//drm_probe_helper.c中实现  由drmModeGetConnector()调用</span><br>    .destroy = drm_connector_cleanup, <br>    .reset = drm_atomic_helper_connector_reset,<br>    .atomic_duplicate_state = drm_atomic_helper_connector_duplicate_state,<br>    .atomic_destroy_state = drm_atomic_helper_connector_destroy_state,  <br>&#125;;<br><br><span class="hljs-comment">//connector helper funcs 中 get_modes实现</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">vkms_connector_get_modes</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> drm_connector *connector)</span><br>&#123;<br>    <span class="hljs-type">int</span> count;<br>    count = drm_add_modes_noedid(connector, <span class="hljs-number">8192</span>, <span class="hljs-number">8192</span>);<br>	drm_set_preferred_mode(connector, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>);<br>    <span class="hljs-keyword">return</span> count;<br>&#125;<br><br><span class="hljs-comment">//connector helper funcs 接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_connector_helper_funcs</span> <span class="hljs-title">vkms_connector_helper_funcs</span> =</span> &#123;<br>    .get_modes = vkms_connector_get_modes,   <span class="hljs-comment">//Add modes to the connector that the panel is attached to and \</span><br><span class="hljs-comment">	                                            return the number of modes added.</span><br>&#125;;<br><br><br><span class="hljs-comment">//encoder funcs接口</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_encoder_funcs</span> <span class="hljs-title">vkms_encoder_funcs</span> =</span> &#123;<br>    .destroy = drm_encoder_cleanup,<br>&#125;;<br><br><span class="hljs-comment">/*初始化各个obj*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vkms_modeset_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    drm_mode_config_init(&amp;drm);  <span class="hljs-comment">//初始化一些全局数据结构，standard properties在此处创建</span><br><br>    drm.mode_config.max_width = <span class="hljs-number">2048</span>;<br>    drm.mode_config.max_height = <span class="hljs-number">2048</span>;<br><br>    drm.mode_config.funcs = &amp;vkms_mode_funcs;   <span class="hljs-comment">//设置mode config函数集</span><br><br>    <span class="hljs-comment">/*创建drm_mode_objects*/</span><br>    drm_universal_plane_init(&amp;drm, &amp;primary, <span class="hljs-number">0</span>, &amp;vkms_plane_funcs, vkms_formats, \<br>    ARRAY_SIZE(vkms_formats), <span class="hljs-literal">NULL</span>, DRM_PLANE_TYPE_PRIMARY, <span class="hljs-literal">NULL</span>);<br>    drm_plane_helper_add(&amp;primary, &amp;vkms_plane_helper_funcs);<br>    drm_crtc_init_with_planes(&amp;drm, &amp;crtc, &amp;primary, <span class="hljs-literal">NULL</span>, &amp;vkms_crtc_funcs, <span class="hljs-literal">NULL</span>);<br>    drm_crtc_helper_add(&amp;crtc, &amp;vkms_crtc_helper_funcs);<br>    drm_encoder_init(&amp;drm, &amp;encoder, &amp;vkms_encoder_funcs, DRM_MODE_ENCODER_VIRTUAL, <span class="hljs-literal">NULL</span>);<br>    drm_connector_init(&amp;drm, &amp;connector, &amp;vkms_connector_funcs, DRM_MODE_CONNECTOR_VIRTUAL);<br>    drm_connector_helper_add(&amp;connector, &amp;vkms_connector_helper_funcs);<br>    drm_connector_attach_encoder(&amp;connector, &amp;encoder);<br>    drm_mode_config_reset(&amp;drm);  <span class="hljs-comment">//This functions calls all the crtc&#x27;s, encoder&#x27;s and connector&#x27;s -&gt;reset callback. </span><br>&#125;<br><br><br>DEFINE_DRM_GEM_CMA_FOPS(drm_driver_fops);   <span class="hljs-comment">//drm_gem_cma_helper.h中已经帮忙定义好了\</span><br><span class="hljs-comment">                                              drm driver的相关fops接口，drm_driver_fops为自定义的fops名</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_driver</span> <span class="hljs-title">vkms_driver</span> =</span> &#123;    <span class="hljs-comment">//drm driver</span><br>    .name = <span class="hljs-string">&quot;vkms&quot;</span>, <br>    .desc = <span class="hljs-string">&quot;virtual kernel mode setting&quot;</span>,<br>    .date = <span class="hljs-string">&quot;2022.10.27&quot;</span>,<br>    .major = <span class="hljs-number">1</span>,<br>    .minor = <span class="hljs-number">0</span>,<br>    .driver_features = DRIVER_MODESET | DRIVER_GEM | DRIVER_ATOMIC,     <span class="hljs-comment">//驱动支持的操作:mode setting, gem, atomic</span><br>    .fops = drm_driver_fops,<br>    .dumb_create = drm_gem_cma_dumb_create,  <span class="hljs-comment">//用于创建gem object并分配物理buffer，直接使用cma helper函数</span><br>&#125;;<br><br><br><span class="hljs-comment">/**模块入口**/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">vkms_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/****</span><br><span class="hljs-comment">     * 初始化drm_dev设备;</span><br><span class="hljs-comment">     * 将drm device和driver关联</span><br><span class="hljs-comment">     * 此函数会使drm_device结构体下的driver成员变量指向drm_driver</span><br><span class="hljs-comment">    */</span><br>    drm_dev_init(&amp;drm, &amp;vkms_driver, <span class="hljs-literal">NULL</span>);<br><br>    vkms_modeset_init();<br><br>    drm_dev_register(&amp;drm, <span class="hljs-number">0</span>); <span class="hljs-comment">//将drm dev注册进drm core</span><br>&#125;<br><br><span class="hljs-comment">/*模块出口*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">vkms_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><br>&#125;<br><br>module_init(vkms_init);<br>module_exit(vkms_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;Hector&quot;</span>);<br></code></pre></td></tr></table></figure>

<ul>
<li>与legacy框架相似，区别主要在于<ul>
<li>在drm_mode_Config中添加了atomic_check等操作函数</li>
<li>在driver中添加了DRIVER_ATOMIC feature</li>
<li>各个drm_mode_objects的funcs和helper funcs改为了atomic接口</li>
<li>在创建完各个drm_mode_objests后使用drm_mode_config_reset</li>
</ul>
</li>
<li>atomic重点在于<ul>
<li>driver.feature添加DRIVER＿ATOMIC标志</li>
<li>drm_mode_config_funcs.atomic_commit()接口是atomic操作的主要入口函数，必须实现</li>
<li>atomic操作依赖vsync，即vblank，因此需要hrtimer提供软件中断信号，驱动初始化时调用drm_vblank_init(),定时器回调函数中调用drm_handle_vblank</li>
<li>在各个drm_mode_objs初始化完成后必须调用drm_mode_congfig_reset()来动态创建各个pipeline的软件状态，即drm_xxx_state</li>
<li>atomic的xxx_funcs必须实现以下接口，它们主要用于维护drm_xxx_state数据结构<ul>
<li>reset()</li>
<li>atomic_duplicate_state()</li>
<li>atomic_destroy_state()</li>
</ul>
</li>
<li>drm_plane_helper_funcs.atomic_update()必须实现</li>
</ul>
</li>
</ul>
<div align="center">

<h3 id="6-GEM驱动概述"><a href="#6-GEM驱动概述" class="headerlink" title="6.GEM驱动概述"></a>6.GEM驱动概述</h3></div>

<blockquote>
<p>前面的代码只实现了KMS相关驱动的框架，还需要为驱动添加GEM的功能</p>
</blockquote>
<h4 id="最简单的GEM驱动"><a href="#最简单的GEM驱动" class="headerlink" title="最简单的GEM驱动"></a>最简单的GEM驱动</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">DEFINE_DRM_GEM_CMA_FOPS(drm_driver_fops);   <span class="hljs-comment">//drm_gem_cma_helper.h中已经帮忙定义好了\</span><br><span class="hljs-comment">                                              drm driver的相关fops接口，drm_driver_fops为自定义的fops名</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">drm_driver</span> <span class="hljs-title">vkms_driver</span> =</span> &#123;    <span class="hljs-comment">//drm driver</span><br>    .name = <span class="hljs-string">&quot;vkms&quot;</span>, <br>    .desc = <span class="hljs-string">&quot;virtual kernel mode setting&quot;</span>,<br>    .date = <span class="hljs-string">&quot;2022.10.27&quot;</span>,<br>    .major = <span class="hljs-number">1</span>,<br>    .minor = <span class="hljs-number">0</span>,<br>    .driver_features = DRIVER_GEM,     <span class="hljs-comment">//驱动支持的操作: gem</span><br>    .fops = drm_driver_fops,<br>    .dumb_create = drm_gem_cma_dumb_create,  <span class="hljs-comment">//用于创建gem object并分配物理buffer，直接使用cma helper函数</span><br>    .gem_vm_ops = &amp;drm_gem_cma_vm_ops,<br>    .gem_free_ovject_unlocked = drm_gem_cma_free_object,<br>&#125;;<br></code></pre></td></tr></table></figure>
<ul>
<li>driver.feature &#x3D; DRIVER_GEM,表明驱动支持GEM操作</li>
<li>driver.dumb_create : 分配dumb buffer 的或调接口，主要完成三件事<ul>
<li>创建gem object</li>
<li>分配gem handle</li>
<li>分配物理buffer</li>
</ul>
</li>
<li>fops中有mmap函数，通常用drm_gem_cma_mmap()实现</li>
<li>gem_vm_ops:主要为mmap服务，必须实现<blockquote>
<p>其实driver中还有dumb_map_offset和dumb_destroy两个接口，分别对应各自的ioctl函数，如果驱动没有实现这两个回调接口， 那么 DRM 框架会使用默认的 drm_gem_dumb_map_offset() 和 drm_gem_dumb_destroy() 代替。</p>
</blockquote>
<!--PC版--></li>
</ul>
<div id="SOHUCS" ></div>
<script charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js" ></script>
<script type="text/javascript">
window.changyan.api.config({
appid: 'cywhVLBNm',
conf: 'prod_449188a899f144a2be2e05b0a1b8f390'
});
</script>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Linux/" class="category-chain-item">Linux</a>
  
  
    <span>></span>
    
  <a href="/categories/Linux/Drivers/" class="category-chain-item">Drivers</a>
  
  
    <span>></span>
    
  <a href="/categories/Linux/Drivers/DRM/" class="category-chain-item">DRM</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>DRM应用及驱动浅析</div>
      <div>http://example.com/2022/10/21/DRM综合/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Hector</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/24/stm32mp157_drm%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90/" title="stm32mp157_drm驱动源码分析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">stm32mp157_drm驱动源码分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/02/linux%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89/" title="linux并发与竞争">
                        <span class="hidden-mobile">linux并发与竞争</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script type="text/javascript">
        var disqus_config = function() {
          this.page.url = 'http://example.com/2022/10/21/DRM%E7%BB%BC%E5%90%88/';
          this.page.identifier = '/2022/10/21/DRM%E7%BB%BC%E5%90%88/';
        };
        Fluid.utils.loadComments('#disqus_thread', function() {
          var d = document, s = d.createElement('script');
          s.src = '//' + 'fluid' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       Hector > 保持好奇-保持热爱 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
